# 知识图谱关系修正工具使用指南

## 📋 问题背景

知识图谱中存在错误的关系类型标注，例如：

```
❌ 错误：瘀血证 -[症状]-> 望诊
❌ 错误：瘀血证 -[症状]-> 闻诊  
❌ 错误：瘀血证 -[症状]-> 切诊
❌ 错误：瘀血证 -[症状]-> 问诊
```

**问题分析**：望诊、闻诊、切诊、问诊是中医的**诊断方法**（四诊法），而不是症状。

**正确关系**：
```
✅ 正确：瘀血证 -[诊断方法]-> 望诊
✅ 正确：瘀血证 -[诊断方法]-> 闻诊
✅ 正确：瘀血证 -[诊断方法]-> 切诊
✅ 正确：瘀血证 -[诊断方法]-> 问诊
```

## 🚀 快速使用

### 模式1: 交互式修正（推荐）

**适用场景**: 首次使用，希望先查看错误再决定是否修正

```bash
cd E:\毕业论文和设计\线上智能中医问答项目\测试与质量保障层\rag评估系统\newragas
python fix_kg_relations.py
```

**执行流程**:
1. 🔍 扫描知识图谱中的错误关系
2. 📋 展示前20个错误关系示例
3. ❓ 询问是否批量修正
4. 🔧 执行批量修正
5. ✅ 验证修正结果
6. 📊 展示修正后的关系示例

### 模式2: 自动修正模式

**适用场景**: 确认要修正，无需交互确认

```bash
python fix_kg_relations.py auto
```

**特点**: 直接扫描并修正，无需手动确认

### 模式3: 查询模式

**适用场景**: 仅查看错误关系，不进行修改

```bash
python fix_kg_relations.py query
```

**功能**:
- 扫描并展示所有错误关系（最多50个）
- 将错误关系列表保存到 `results/wrong_relations.json`
- **不会修改知识图谱**

## 📊 预期效果

### 修正前

```
问题: 诊断瘀血证的方法有哪些？

检索到的上下文:
- 瘀血证 -[症状]-> 望诊
- 瘀血证 -[症状]-> 闻诊  
- 瘀血证 -[症状]-> 切诊

生成的答案:
"同时，如果怀疑自己患有瘀血证，建议及时就医并接受专业医生的诊治。"
❌ 答案不完整，长度仅32字符
```

### 修正后

```
问题: 诊断瘀血证的方法有哪些？

检索到的上下文:
- 瘀血证 -[诊断方法]-> 望诊
- 瘀血证 -[诊断方法]-> 闻诊
- 瘀血证 -[诊断方法]-> 切诊

生成的答案:
"中医诊断瘀血证有多种方法，包括：
1. 望诊：通过观察病人的面色、舌质、舌苔等来判断瘀血证的程度。
2. 闻诊：通过听取病人的呼吸、声音、脉搏等来判断瘀血证的类型。
3. 切诊：通过按摩病人的经络、穴位、肌肉等来判断瘀血证的部位和程度。
..."
✅ 答案完整详细，长度200+字符
```

## 🔧 技术细节

### 修正逻辑

```cypher
-- Cypher查询语句
MATCH (source)-[old_rel:症状]->(target)
WHERE target.name IN ['望诊', '闻诊', '问诊', '切诊']
CREATE (source)-[new_rel:诊断方法]->(target)
SET new_rel = properties(old_rel)  -- 保留原关系的属性
DELETE old_rel
```

### 识别规则

**诊断方法关键词**: `['望诊', '闻诊', '问诊', '切诊', '望', '闻', '问', '切']`

**匹配条件**:
- 关系类型为 `症状`
- 目标节点名称在诊断方法列表中

## 📝 输出示例

```
================================================================================
知识图谱关系修正工具
================================================================================

功能说明：
  将错误的 '证候 -症状-> 诊断方法' 修正为 '证候 -诊断方法-> 诊断方法'
  例如：'瘀血证 -症状-> 望诊' 改为 '瘀血证 -诊断方法-> 望诊'

================================================================================
🔍 正在扫描知识图谱中的错误关系...
================================================================================

📊 发现 42 个错误关系

📋 错误关系示例（前20个）：
--------------------------------------------------------------------------------
  1. 瘀血证 -[症状]-> 望诊
     ❌ 应改为: 瘀血证 -[诊断方法]-> 望诊
  2. 瘀血证 -[症状]-> 闻诊
     ❌ 应改为: 瘀血证 -[诊断方法]-> 闻诊
  3. 瘀血证 -[症状]-> 切诊
     ❌ 应改为: 瘀血证 -[诊断方法]-> 切诊
  ...

================================================================================
是否批量修正这些错误关系？(y/n): y

================================================================================
🔧 开始批量修正错误关系...
================================================================================

[1/42] 修正: 瘀血证 -> 望诊 ... ✅
[2/42] 修正: 瘀血证 -> 闻诊 ... ✅
[3/42] 修正: 瘀血证 -> 切诊 ... ✅
...

================================================================================
📊 修正完成统计:
================================================================================
  ✅ 成功: 42 个
  ❌ 失败: 0 个
  📈 成功率: 100.0%

================================================================================
🔍 验证修正结果...
================================================================================

✅ 验证通过！所有错误关系已修正。

================================================================================
🎉 关系修正流程完成！
================================================================================
```

## ⚠️ 注意事项

1. **备份数据**: 虽然脚本很安全，但建议在修正前备份Neo4j数据库
2. **Neo4j配置**: 确保Neo4j正在运行（bolt://localhost:7687）
3. **权限**: 需要有Neo4j的写入权限
4. **影响范围**: 仅修正"症状"关系指向诊断方法的情况，不影响其他关系

## 🔗 相关文件

- **主程序**: `fix_kg_relations.py`
- **测试程序**: `test_kg_rag_flow.py`
- **评估器**: `kg_ragas_evaluator.py`
- **结果目录**: `results/`

## 📞 常见问题

### Q1: 修正后需要重启服务吗？

**A**: 不需要。Neo4j的修改是实时生效的，但建议重新运行测试验证效果。

### Q2: 修正失败怎么办？

**A**: 检查：
- Neo4j是否正常运行
- 连接配置是否正确
- 是否有写入权限

### Q3: 如何恢复修正前的状态？

**A**: 可以运行反向修正：

```cypher
MATCH (source)-[old_rel:诊断方法]->(target)
WHERE target.name IN ['望诊', '闻诊', '问诊', '切诊']
CREATE (source)-[new_rel:症状]->(target)
DELETE old_rel
```

但**不建议恢复**，因为修正后的关系才是正确的。

## 🎯 下一步

修正完成后，运行测试验证效果：

```bash
python test_kg_rag_flow.py
```

预期结果：
- ✅ "姜的功效"问题：答案完整（200+ 字符）
- ✅ "诊断瘀血证"问题：答案完整（200+ 字符）

