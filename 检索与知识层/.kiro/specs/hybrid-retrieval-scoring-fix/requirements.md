# 混合检索系统评分计算修复需求文档

## 介绍

当前混合检索系统存在评分计算问题，导致所有检索源（BM25、向量、图谱）返回相同的评分，无法体现不同检索方法的差异性和融合算法的有效性。本需求文档旨在修复这些评分计算问题，提升系统的检索质量和用户体验。

## 需求

### 需求 1：修复RRF融合算法评分计算

**用户故事：** 作为系统开发者，我希望RRF融合算法能够正确计算各检索源的贡献度，以便准确反映融合结果的质量。

#### 验收标准

1. WHEN 执行RRF融合时 THEN 系统 SHALL 根据每个结果在各检索源中的排名位置计算RRF评分
2. WHEN 计算RRF评分时 THEN 系统 SHALL 使用公式 1/(k+rank) 其中k=60，rank为排名位置
3. WHEN 同一内容出现在多个检索源中时 THEN 系统 SHALL 累加各源的RRF贡献值作为最终评分
4. WHEN 内容只在部分检索源中出现时 THEN 系统 SHALL 仅计算出现源的RRF贡献
5. WHEN 融合完成后 THEN 系统 SHALL 按最终RRF评分降序排列结果

### 需求 2：差异化各检索适配器的评分机制

**用户故事：** 作为系统用户，我希望不同检索方法能够产生有区别的评分，以便了解各方法对查询的匹配程度。

#### 验收标准

1. WHEN BM25检索执行时 THEN 系统 SHALL 基于关键词匹配度和词频计算评分，范围在0.1-1.0之间
2. WHEN 向量检索执行时 THEN 系统 SHALL 基于语义相似度和内容相关性计算评分，范围在0.1-0.95之间
3. WHEN 图检索执行时 THEN 系统 SHALL 基于实体关系和结构复杂度计算评分，范围在0.1-0.98之间
4. WHEN 计算评分时 THEN 各检索源 SHALL 使用不同的评分策略以体现其特点
5. WHEN 同一查询执行时 THEN 不同检索源 SHALL 产生有差异的评分分布

### 需求 3：优化评分展示和调试信息

**用户故事：** 作为系统调试者，我希望能够清楚地看到融合过程中各检索源的贡献和计算细节，以便分析和优化系统性能。

#### 验收标准

1. WHEN 显示融合结果时 THEN 系统 SHALL 展示每个结果的最终融合评分（保留4位小数）
2. WHEN 显示各源评分时 THEN 系统 SHALL 展示每个检索源的原始评分和RRF贡献值
3. WHEN 结果来自多个检索源时 THEN 系统 SHALL 显示所有贡献源的名称
4. WHEN 计算融合评分时 THEN 系统 SHALL 记录详细的计算过程用于调试
5. WHEN 评分异常时 THEN 系统 SHALL 提供错误信息和降级处理

### 需求 4：增强评分计算的鲁棒性

**用户故事：** 作为系统管理员，我希望评分计算系统能够处理各种异常情况，确保系统稳定运行。

#### 验收标准

1. WHEN 检索源返回空结果时 THEN 系统 SHALL 跳过该源并继续融合其他源的结果
2. WHEN 检索源评分为0或负数时 THEN 系统 SHALL 设置最小评分阈值0.001
3. WHEN 所有检索源都失败时 THEN 系统 SHALL 返回空结果并记录错误日志
4. WHEN 融合过程中出现异常时 THEN 系统 SHALL 使用降级策略返回单一源的结果
5. WHEN 评分计算溢出时 THEN 系统 SHALL 进行数值范围检查和修正

### 需求 5：添加评分计算验证和测试

**用户故事：** 作为质量保证工程师，我希望有完整的测试覆盖来验证评分计算的正确性，确保修复后的系统按预期工作。

#### 验收标准

1. WHEN 执行单元测试时 THEN 系统 SHALL 验证RRF算法的数学计算正确性
2. WHEN 执行集成测试时 THEN 系统 SHALL 验证各检索源评分的差异性
3. WHEN 执行端到端测试时 THEN 系统 SHALL 验证完整的融合流程
4. WHEN 测试边界情况时 THEN 系统 SHALL 正确处理空结果、单一结果等场景
5. WHEN 性能测试时 THEN 评分计算 SHALL 在可接受的时间范围内完成