智能中医问答系统 - 详细项目结构
================================================================================

【各层职责概述】

【重大更新 2025-12-XX】
系统升级为优化的RAG流程架构（v4.4）：
- 实现完整的五层架构：文档层、检索与知识层、应用协调层、部署与基础设施层、测试与质量保障层
- 二元智能路由：基于Qwen-Flash API的实体识别，实现vector_only/hybrid两种路由策略
- 精确检索召回规则：
  * 纯向量检索：召回3个，使用3个
  * 混合检索：召回5向量+5图谱（10个），生成用3向量+5图谱（8个），评估用3向量
- 移除向量检索关键词增强：直接返回原始文档内容，不再添加"关键词: ..."前缀
- 检索结果标记优化：所有检索结果正确标记source字段（vector/graph）
- 结构化组件管理：参照评估系统实现组件状态跟踪、预热机制和错误处理
- 混合检索优化：向量检索(Faiss+GTE) + 知识图谱检索(Neo4j)并行执行后智能融合
- 端到端测试体系：完整的生产流程测试、RAGAS评估框架和性能监控

1. **文档层**：提供完整的项目文档、API文档、部署指南和使用说明。

2. **检索与知识层**：负责中医知识的采集、清洗与图谱构建；实现向量语义检索和
   知识图谱检索；提供高质量向量索引与实体关系存储。

3. **应用协调层**：负责Qwen-Flash智能路由分类；根据查询复杂度选择检索策略；
   实现检索结果的融合与排序；处理模型调用与答案生成；提供FastAPI接口。

4. **部署与基础设施层**：负责Docker配置、启动脚本、环境配置和系统部署。

5. **测试与质量保障层**：负责单元测试、集成测试、RAGAS评估和性能监控。

================================================================================

一、文档层 【已实现】
├── README.md - 项目主要说明文档
├── docs/
│   ├── 详细项目结构.md - 项目架构详细说明
│   ├── 部署指南.md - 系统部署和配置指南
│   ├── API文档.md - 接口使用说明
│   └── requirements.txt - 依赖说明
└── 项目介绍.md - 项目总体介绍

二、检索与知识层 【已实现】
位置: 检索与知识层/
├── faiss_rag/ - Faiss向量检索系统
│   ├── vector_retrieval_system/
│   │   ├── embedding_service.py - 嵌入模型服务(GTE)
│   │   ├── faiss_manager.py - Faiss向量库管理器
│   │   ├── vector_retrieval.py - 向量检索器
│   │   └── config.py - 向量检索配置
│   ├── 向量数据库_768维/ - Faiss持久化存储
│   │   ├── faiss.index - Faiss索引文件
│   │   ├── metadata.pkl - 元数据文件
│   │   └── documents.json - 文档数据
│   └── 构建768维向量数据库.py - 数据库构建脚本
├── Graphrag/ - 知识图谱系统
│   ├── Knowledge_Graph/ - Neo4j图谱数据
│   └── scripts/ - 图谱构建脚本
└── keyword/ - 关键词库
    └── knowledge_graph_entities_only.csv - 中医实体库(46,697个)

三、应用协调层 【已实现】
位置: 应用协调层/middle/
├── api/ - FastAPI接口层
│   ├── main_app.py - FastAPI应用入口和组件初始化
│   └── v1_routes.py - API路由定义
├── core/ - 核心业务逻辑
│   ├── retrieval_coordinator.py - 智能路由检索协调器
│   ├── result_fusion.py - 结果融合引擎
│   └── hybrid_retriever.py - 混合检索器
├── services/ - 服务层
│   ├── rag_chain.py - RAG核心链路
│   ├── model_service.py - 模型调用服务
│   └── prompt_templates.py - 提示词模板
├── utils/ - 工具层
│   ├── intelligent_router.py - Qwen-Flash智能路由分类器
│   ├── query_classifier.py - 查询分类器
│   ├── optimized_entity_extractor.py - 实体提取器
│   ├── local_enhancer.py - 查询扩展和重排序
│   └── logging_utils.py - 日志工具
├── adapters/ - 检索适配器
│   ├── simple_vector_adapter.py - 向量检索适配器
│   └── graph_adapter.py - 知识图谱检索适配器
├── models/ - 数据模型
│   ├── data_models.py - 数据结构定义
│   └── exceptions.py - 异常定义
└── config/ - 配置管理
    ├── service_config.yaml - 主配置文件
    └── entity_extraction.yaml - 实体提取配置

四、部署与基础设施层 【已实现】
位置: 部署与基础设施层/
├── 启动服务.py - 快捷启动脚本
├── scripts/
│   └── start_langchain_service.py - 主启动脚本
├── docker/ - Docker配置（预留）
└── config/ - 环境配置

五、测试与质量保障层 【已实现】
位置: 测试与质量保障层/
├── tests/
│   ├── test_production_rag_flow.py - 端到端生产流程测试
│   └── test_components.py - 组件单元测试
├── rag评估系统/
│   ├── newragas/
│   │   ├── hybrid_ragas_evaluator_v4.py - RAGAS评估系统
│   │   └── test_v4_simple.py - 评估测试脚本
│   └── results/ - 评估结果存储
└── testdataset/
    ├── knowledge_graph_entities_only.csv - 实体测试数据
    └── merged_datasets_classified.csv - 分类测试数据

================================================================================
系统特性说明
================================================================================

1. **二元智能路由**：
   - vector_only: 实体主导型查询（纯向量检索）
   - hybrid: 复杂推理型查询（混合检索：向量 + 图谱）

2. **检索策略与召回规则**：
   - **纯向量检索（vector_only）**：
     * 召回：3个文档
     * 生成使用：3个文档
   - **混合检索（hybrid）**：
     * 召回：5个向量文档 + 5个知识图谱文档（共10个）
     * 生成使用：3个向量文档 + 5个知识图谱文档（共8个）
     * 评估使用：3个向量文档（仅用于RAGAS评估）
   
3. **检索增强技术**：
   - 查询扩展：text2vec-base-chinese-paraphrase模型
   - 重排序：bge-reranker-base模型
   - 向量检索：Faiss + GTE嵌入模型（已移除关键词增强）
   - 图谱检索：Neo4j + 实体提取

3. **组件管理**：
   - 结构化初始化：参照评估系统实现组件状态跟踪
   - 预热机制：启动时自动预热检索组件
   - 错误处理：完善的异常处理和降级策略

4. **技术栈**：
   - 后端：FastAPI + Uvicorn
   - 检索：Faiss + Neo4j + LangChain
   - 模型：Qwen3-1.7B + Qwen-Flash API
   - 嵌入：GTE (General Text Embeddings)

5. **测试体系**：
   - 端到端测试：test_production_rag_flow.py
   - RAGAS评估：基于DeepSeek API的质量评估
   - 性能监控：内置统计和日志系统

================================================================================
更新历史
================================================================================

- **2025-12-XX v4.4**: 优化RAG流程，统一路由决策为vector_only/hybrid，精确文档召回和使用规则，移除向量关键词增强
- **2025-10-30 v4.3**: 五层分布式架构，实现完整的文档层、检索与知识层、应用协调层、部署与基础设施层、测试与质量保障层
- **2025-10-27 v4.2**: 从三源混合检索升级为二元智能路由，移除BM25，迁移到Faiss向量数据库
- **2025-10-19 v4.1**: 移除BM25模块，系统瘦身优化
- **2025-10-15 v4.0**: 实现智能路由混合检索架构
- **2025-09-01 v3.0**: 实现三源混合检索架构

================================================================================
架构设计理念
================================================================================

本系统采用**五层分布式架构**设计理念：

1. **文档层**：提供完整的项目文档和使用指南，确保项目可维护性和可扩展性
2. **检索与知识层**：专注数据存储和检索技术，屏蔽底层数据源的复杂性
3. **应用协调层**：核心业务逻辑层，实现智能路由、组件管理和API服务
4. **部署与基础设施层**：处理系统部署、配置管理和运行环境
5. **测试与质量保障层**：确保系统质量和性能，提供完整的测试和评估体系

每一层都有明确的职责边界，通过标准接口进行通信，实现高内聚、低耦合的系统设计。

================================================================================
技术栈特点总结
================================================================================

1. **检索技术栈**：
   - Faiss向量数据库：15万条文档，查询速度<10ms
   - Neo4j知识图谱：46,697个实体，高效图检索
   - GTE嵌入模型：中文语义嵌入，768维高精度

2. **AI模型栈**：
   - Qwen3-1.7B：主生成模型，支持中英双语
   - Qwen-Flash API：智能路由判断，实时API调用
   - LoRA微调：中医领域专业化适配

3. **系统架构**：
   - FastAPI异步框架：高并发，低延迟
   - 组件状态管理：结构化初始化和预热
   - 二元智能路由：精准检索策略选择

================================================================================
项目总结
================================================================================

本项目实现了基于**五层分布式架构**的智能中医问答系统，采用**二元智能路由**技术，结合向量检索和知识图谱检索，为用户提供专业、准确的中医知识服务。

**核心创新点**：
- 五层分布式架构设计，实现职责分离和高可维护性
- 基于Qwen-Flash API的二元智能路由，精准选择检索策略
- 向量检索(Faiss+GTE) + 知识图谱检索(Neo4j)的混合检索融合
- 结构化组件管理和预热机制，确保系统稳定运行
- 完整的测试和评估体系，保证系统质量

**技术特色**：
- 15万条向量化中医文档，毫秒级检索响应
- 46,697个中医实体知识图谱，支持复杂关系查询
- Qwen3-1.7B大语言模型 + LoRA微调，专业中医问答
- FastAPI异步框架，支持高并发访问
- 端到端RAGAS评估体系，确保回答质量

================================================================================
