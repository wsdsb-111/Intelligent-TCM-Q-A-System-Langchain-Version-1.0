# 基于智能路由混合检索增强生成的智能中医问答系统

## 🔄 架构更新说明（v4.4 - 2025-12-XX）

### 重大变更
本系统升级为优化的**RAG流程架构**，实现精确的文档召回和使用规则：
- ✅ **五层架构实现**：文档层、检索与知识层、应用协调层、部署与基础设施层、测试与质量保障层
- ✅ **二元智能路由**：基于Qwen-Flash API的实体识别，实现vector_only/hybrid两种路由策略
- ✅ **精确检索召回规则**：
  * 纯向量检索：召回3个文档，生成使用3个文档
  * 混合检索：召回5向量+5图谱（10个），生成用3向量+5图谱（8个），评估用3向量
- ✅ **移除关键词增强**：向量检索已移除关键词增强功能，直接返回原始文档内容
- ✅ **检索结果标记**：所有检索结果正确标记source字段（vector/graph），支持精确过滤和统计
- ✅ **生成文档追踪**：metadata中包含selected_for_generation字段，追踪实际用于生成的文档
- ✅ **查询扩展与重排序**：集成text2vec-base-chinese-paraphrase查询扩展和bge-reranker-base重排序
- ✅ **结构化组件管理**：参照评估系统实现组件状态跟踪、预热机制和错误处理
- ✅ **混合检索优化**：向量检索(Faiss+GTE) + 知识图谱检索(Neo4j)并行执行后智能融合
- ✅ **端到端测试体系**：完整的生产流程测试、RAGAS评估框架和性能监控

## 项目概述

本项目是一个基于**五层分布式架构**的智能中医问答系统，采用**二元智能路由**技术，结合向量检索和知识图谱检索，为用户提供专业、准确的中医知识问答服务。系统采用Qwen-Flash API智能路由分类器，整合Faiss向量检索和Neo4j知识图谱检索，结合Qwen3-1.7B微调大语言模型，构建了一个高效、稳定的中医知识问答平台。

### 项目背景与意义

中医作为中华民族的传统医学瑰宝，拥有数千年的历史积淀和丰富的理论体系。然而，中医知识的复杂性、专业性以及传统传承方式的局限性，使得普通用户难以快速获取准确的中医知识。本项目通过现代人工智能技术，特别是大语言模型和检索增强生成技术，为中医知识的数字化传承和智能化应用提供了创新解决方案。

### 核心创新点

1. **五层分布式架构设计**：文档层、检索与知识层、应用协调层、部署与基础设施层、测试与质量保障层，实现职责分离和高可维护性
2. **二元智能路由技术**：基于Qwen-Flash API的实体识别和复杂推理判断，实现精准路由决策
3. **二元自适应检索策略**：
   - **纯向量检索(vector_only)**：实体主导型查询，直接使用Faiss向量搜索
   - **混合检索(hybrid)**：复杂推理型查询，向量+图谱并行检索后智能融合
4. **混合检索融合技术**：向量检索(Faiss+GTE) + 知识图谱检索(Neo4j)并行执行，智能结果融合
5. **结构化组件管理**：参照评估系统实现组件状态跟踪、预热机制和错误处理
6. **大规模中医知识库**：15万条向量化中医文档 + 46,697个中医实体知识图谱
7. **端到端测试体系**：完整的生产流程测试、RAGAS评估框架和性能监控
8. **高性能响应系统**：平均28.66秒端到端响应，支持并发处理
9. **完整的工程化体系**：从单元测试到生产部署的全生命周期管理
10. **技术栈优化**：FastAPI异步框架 + Faiss高效检索 + Neo4j图谱查询 + Qwen模型推理

## 系统架构设计

### 整体架构

系统采用**五层分布式架构设计**，各层职责明确，模块化程度高，从底层数据到顶层交互形成完整的技术栈：

```
┌─────────────────────────────────────────────────────────────────────┐
│                   第一层：文档层                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  README.md    │  │  API文档     │  │  部署指南    │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  项目结构     │  │  使用说明    │  │  配置文档   │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────────────────────────────────────────┐
│               第二层：检索与知识层                                │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  Faiss向量   │  │  Neo4j图谱   │  │  GTE嵌入    │            │
│  │  数据库      │  │  检索        │  │  模型       │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  15万文档    │  │  46,697实体  │  │  中医知识库 │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────────────────────────────────────────┐
│                第三层：应用协调层                                │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  查询分类器  │  │  检索协调器  │  │  结果融合器  │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  模型服务    │  │  RAG链路     │  │  FastAPI接口 │            │
│  │ (+4种模式)   │  │ (+3种提示词) │  │              │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────────────────────────────────────────┐
│                   第四层：部署与基础设施层                          │
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │
│  │   向量检索       │  │   知识图谱检索   │  │  关键词增强     │ │
│  │    (Faiss1.12.0 )  │  │  (Neo4j)        │  │  (+实体库)      │ │
│  │  BGE-base-zh     │  │  47K节点       │  │  停用词过滤     │ │
│  │  语义理解        │  │  40万关系      │  │  单字实体       │ │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────────────────────────────────────────┐
│                      第五层：模型层 ✅                              │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              Qwen3-1.7B 基座模型 (17亿参数)                │ │
│  └──────────────────────────────────────────────────────────────┘ │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  阶段1:探索期 │  │  阶段2:收敛期 │  │  阶段3:精化期 │            │
│  │  LoRA微调    │  │  LoRA微调    │  │  LoRA微调    │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└─────────────────────────────────────────────────────────────────────┘

                        支撑体系
┌─────────────────────────────────────────────────────────────────────┐
│  部署层: Docker + Nginx + Prometheus + Grafana                      │
│  测试层: 单元测试 + 集成测试 + 质量评估                             │
│  文档层: 技术文档 + API文档 + 使用指南                              │
└─────────────────────────────────────────────────────────────────────┘
```

### 各层详细设计

#### 第一层：用户交互层（前端层）

**Dify低代码平台集成 [预留接口]**
- **界面组件**：文本输入框、图片上传组件、结果展示卡片
- **会话管理**：多轮对话支持、上下文缓存机制
- **交互优化**：Loading动画、响应可视化渲染
- **工作流配置**：可视化流程设计、低代码配置
- **部署方式**：Dify云托管工作流 + 本地服务集成

#### 第二层：多模态工具层（扩展层）

**MCP (Model Context Protocol) 服务架构 [预留接口]**

**MCP Server端（Python实现）**
- **图像分析工具**：
  - 舌诊图像识别（舌质、舌苔分析）
  - 脉象识别与分析
  - 基于CLIP/GPT-4V的视觉模型
- **文字识别工具**：
  - OCR文字提取（中医古籍识别）
  - 手写处方识别
- **学术搜索工具**：
  - CNKI中文文献检索
  - PubMed英文文献检索
  - 通用Web搜索集成
- **多模态模型**：
  - 视觉-语言联合模型
  - 多模态嵌入向量生成

**MCP Client端（集成到LangChain）**
- **工具路由**：根据输入类型（文本/图像）智能路由
- **结果融合**：多模态信息整合与融合
- **协议通信**：MCP标准协议实现

#### 第三层：应用协调层（中间层）【已更新 v4.0】

**智能路由分类器 (新增)**
- **分类模型**：Qwen-Flash API + 实体识别
- **路由类型**：二元智能路由
  - **vector_only**：实体主导型查询，纯向量检索（1.0, 0.0）
  - **hybrid**：复杂推理型查询，混合检索（0.5, 0.5）
- **分类准确率**：>85%
- **置信度评分**：支持0.8-0.95分，阈值可配置（默认0.65）
- **实体库**：knowledge_graph_entities_only.csv（知识图谱实体）
- **核心特性**：
  - Qwen-Flash API推理：复杂推理判断、功效查询判断、实体有效性验证
  - 实体提取：支持单字实体（如"姜"、"枣"），优先匹配长实体
  - 模型管理：支持API调用和错误处理
  - 备用方法：API失败时使用规则判断（fallback机制）

**向量语义检索子系统**
- **嵌入模型**：GTE (General Text Embeddings)（768维向量）
- **向量数据库**：Faiss 1.12.0持久化存储（155,902条文档）
- **检索策略**：余弦相似度计算，支持语义理解
- **关键词增强**：已移除，直接返回原始文档内容（不再添加"关键词: ..."前缀）
- **优化特性**：缓存机制，批量处理优化，无Windows死锁
- **响应时间**：1-2秒
- **查询速度**：8.76ms，QPS 114
- **召回规则**：
  * 纯向量模式（vector_only）：召回3个文档，生成使用3个文档
  * 混合模式（hybrid）：召回5个文档，生成时使用前3个

**知识图谱检索子系统 (GraphRAG) - 神农中医知识图谱**
- **图谱名称**：神农中医知识图谱
- **图谱规模**：47,335个实体节点，402,184个关系边
- **数据库**：Neo4j图数据库 (neo4j://127.0.0.1:7687)
- **实体类型**：方剂、药材、症状、疾病、治法等
- **关系类型**：489种（病因、治疗、包含、引起、症状、功效、属于、组成、配伍、证候等）
- **检索深度**：最大3层关系遍历
- **智能特性**：LLM实体提取，动态关系推理
- **响应时间**：1.5-2.5秒
- **主要实体**：神昏、痫、川芎、桂枝、红花等
- **核心模块**：
  - 图谱构建器（graph_builder.py）
  - 实体提取器（entity_extractor.py）
  - 关系提取器（relation_extractor.py）
  - 图谱检索器（graph_retriever.py）
  - 查询引擎（query_engine.py）

**BM25关键词检索子系统 (已废弃)**
- 该模块已从v4.0中移除
- 代码和数据保留作为备份
- 如需恢复，请参考Git历史记录

#### 第五层：模型层（基础层）【已更新 v4.0】

**当前使用模型**
- **模型名称**：Qwen3-1.7B微调模型
- **模型规模**：17亿参数
- **模型类型**：对话式大语言模型
- **微调方法**：LoRA（Low-Rank Adaptation）
- **存储位置**：模型层/model/checkpoint-7983/
- **状态**：当前使用中（2025-10-19微调完成）

**智能路由模型 (新增)**
- **模型名称**：BERT-base-chinese
- **用途**：查询分类和路由决策
- **存储位置**：模型层/model/bert-base-chinese/
- **状态**：当前使用中

**最新微调模型（当前使用）**
- **检查点**：checkpoint-7983
- **目录**：模型层/model/checkpoint-7983/
- **微调完成日期**：2025-10-19
- **微调数据**：中医专业问答数据集
- **训练状态**：已完成，当前使用中
- **性能提升**：相比基础模型，中医专业知识准确性显著提升

**微调模型（历史版本）**

**checkpoint-5584**
- **目录**：模型层/checkpoint-5584/
- **状态**：已被checkpoint-7983替代
- **说明**：之前版本的微调模型

**三阶段微调（早期版本）**
- **阶段1-探索期**：tcm_cleaned_stage1_exploration/ (checkpoint-5623)
- **阶段2-收敛期**：tcm_cleaned_stage2_convergence/ (checkpoint-5507)
- **阶段3-精化期**：tcm_cleaned_stage3_refinement/ (checkpoint-4928)
- **状态**：历史版本，已不再使用

**模型加载脚本**
- **load_base_model.py**：加载Qwen基础模型
- **load_finetuned_model.py**：加载微调后的模型
- **load_model_advanced.py**：高级加载选项（量化、设备选择等）

**模型评估**
- **评估报告**：save1/目录下的评估结果
- **性能指标**：准确率、响应时间、专业性评分

### 支撑体系

除了五层核心架构外，系统还包含完整的支撑体系：

#### 部署与基础设施层

**容器化部署**
- **Docker容器**：系统容器化定义（Dockerfile）
- **服务编排**：多服务协同管理（docker-compose.yml）
- **环境配置**：环境变量模板（env.example）

**反向代理与负载均衡**
- **Nginx配置**：反向代理和负载均衡（nginx/nginx.conf）
- **静态资源服务**：前端资源托管
- **SSL/TLS支持**：HTTPS安全传输

**监控与运维**
- **Prometheus**：性能指标采集（prometheus.yml）
- **Grafana**：可视化监控仪表盘
- **日志系统**：结构化日志收集和分析
- **健康检查**：系统健康状态监控

**启动脚本**
- **start.py**：主启动脚本
- **start_langchain_service.py**：LangChain服务启动
- **start_docker.sh**：Docker容器启动
- **stop_docker.sh**：Docker容器停止

#### 测试与质量保障层

**单元测试**
- **test_system.py**：系统集成测试
- **test_final_hybrid_rag.py**：混合检索完整测试
- **diagnose_modules.py**：模块诊断工具

**质量测试**
- **qa_quality_test.py**：问答质量评估测试
- **test_samples.jsonl**：标准测试样本数据
- **qa_test_report.json**：测试报告和评分

**验证脚本**
- **verify_retrieval_modules.py**：检索模块功能验证
- **verify_interface_integration.py**：接口集成验证
- **health_check.py**：系统健康检查
- **check_environment.py**：环境依赖检查

**快速启动工具**
- **run_test.bat**：Windows批处理测试脚本
- **启动服务.py**：中文快捷启动脚本
- **测试系统.py**：中文快捷测试脚本

#### 文档层

**技术文档**
- **README.md**：项目主文档
- **QUICKSTART_LANGCHAIN.md**：LangChain快速开始指南
- **DEPLOYMENT.md**：部署文档
- **LANGCHAIN_SERVICE_README.md**：LangChain服务详细说明

**中文文档**
- **快速使用指南.md**：中文快速上手指南
- **配置说明.md**：配置文件详细说明
- **混合检索修复说明.md**：技术问题解决方案

**API文档**
- **Swagger UI**：交互式API文档（/docs）
- **ReDoc**：API参考文档（/redoc）

### 五层架构职责总结

| 层级 | 名称 | 核心职责 | 关键技术 | 状态 |
|------|------|----------|----------|------|
| **第一层** | 用户交互层 | 用户界面展示、交互体验优化、会话管理、多轮对话支持、输入输出可视化渲染 | Dify低代码平台 | 预留接口 |
| **第二层** | 多模态工具层 | 图像分析（舌诊、脉象识别）、OCR文字提取、学术搜索（CNKI/PubMed）、通用Web搜索、多模态内容融合 | MCP协议、CLIP、GPT-4V | 预留接口 |
| **第三层** | 应用协调层 | 查询意图分类与智能路由、三源检索结果加权融合与排序、模型调用与答案生成、RESTful API接口、系统服务编排 | LangChain、FastAPI | ✅ 已实现 |
| **第四层** | 检索与知识层 | 中医知识采集、清洗与图谱构建、向量语义检索、知识图谱检索、高质量文档索引与实体关系存储 | Faiss、Neo4j | ✅ 已实现 |
| **第五层** | 模型层 | 基础语言模型提供、领域知识微调、文本生成与理解、实体识别与提取 | Qwen1.5-1.8B、LoRA | ✅ 已实现 |

**架构特点**：
- ✅ **模块化设计**：各层独立可插拔，便于维护和升级
- ✅ **职责分离**：每层职责明确，避免功能耦合
- ✅ **可扩展性**：预留多模态和前端接口，支持未来扩展
- ✅ **工程化完善**：包含完整的测试、部署、监控体系
- ✅ **技术先进**：采用业界最新的RAG、知识图谱、大模型技术

## 核心技术实现

### 完整RAG流程【v4.4优化】

系统采用**智能路由 + 精确召回 + 文档选择 + 增强生成**的完整流程：

**RAG流程步骤**
```
1. 启动FastAPI服务并加载组件
   ├── 加载向量适配器（Faiss + GTE）
   ├── 加载图谱适配器（Neo4j）
   ├── 加载智能路由器（Qwen-Flash API）
   ├── 加载模型服务（Qwen3-1.7B + LoRA）
   └── 预热检索组件

2. 用户输入问题
   └── 接收用户查询请求

3. 智能路由分类
   ├── 使用Qwen-Flash API进行路由判断
   ├── 返回路由决策：vector_only 或 hybrid
   └── 返回路由置信度

4. 查询扩展（可选）
   ├── 使用text2vec-base-chinese-paraphrase模型
   └── 扩展原始查询以提升召回

5. 向量检索/混合检索召回文档
   ├── vector_only模式：
   │   ├── 向量检索：召回3个文档
   │   └── 生成使用：3个文档
   └── hybrid模式：
       ├── 向量检索：召回5个文档
       ├── 图谱检索：召回5个文档
       └── 总召回：10个文档（5向量+5图谱）

6. 重排序（可选）
   ├── 使用bge-reranker-base模型
   └── 对召回文档按相关性重新排序

7. 选出生成回答的文档
   ├── vector_only模式：使用所有3个文档
   └── hybrid模式：使用3个向量文档 + 5个图谱文档（共8个）

8. 模型接受文档生成回答
   ├── 根据路由决策选择提示词模板
   ├── 使用统一生成参数（与评估系统一致）
   └── Qwen3-1.7B模型生成最终答案

9. 输出结果
   ├── 返回答案和检索结果
   ├── 检索结果包含source字段标记（vector/graph）
   └── metadata包含selected_for_generation字段
```

**智能路由决策流程**
```python
# 1. Qwen-Flash智能路由分类
route_type, confidence = intelligent_router.classify(query)
# 返回: ("vector_only", 0.9) 或 ("hybrid", 0.85)

# 2. 根据路由类型执行检索
if route_type == "vector_only":
    # 纯向量检索：召回3个，使用3个
    vector_results = vector_search(query, top_k=3)
    generation_docs = vector_results[:3]  # 使用全部3个
    all_retrieval_docs = vector_results  # 总召回3个
    
elif route_type == "hybrid":
    # 混合检索：向量召回5个，图谱召回5个
    vector_results = vector_search(query, top_k=5)  # 召回5个
    graph_results = graph_search(query, top_k=5)    # 召回5个
    all_retrieval_docs = vector_results + graph_results  # 总召回10个
    generation_docs = vector_results[:3] + graph_results[:5]  # 使用3向量+5图谱（8个）

# 3. 根据路由决策选择提示词模板
if route_type == "vector_only":
    prompt_template = VECTOR_TEMPLATE
    generation_mode = "vector"
else:  # hybrid
    prompt_template = HYBRID_TEMPLATE
    generation_mode = "hybrid"

# 4. 生成答案（使用统一的生成参数）
answer = model.generate(
    prompt=build_prompt(query, generation_docs, prompt_template),
    max_new_tokens=512,
    temperature=0.1,
    top_p=0.4,
    num_beams=3,
    repetition_penalty=1.3,
    # ... 其他参数与评估系统一致
)

# 5. 返回结果
return {
    "answer": answer,
    "retrieval_results": format_with_source(all_retrieval_docs),  # 10个，含source字段
    "metadata": {
        "routing_decision": route_type,
        "selected_for_generation": format_with_source(generation_docs),  # 8个，含source字段
        ...
    }
}
```

**智能路由优势**
- ✅ **自适应策略选择**：根据查询特征自动选择最优检索模式
- ✅ **性能提升25%**：单一检索模式避免不必要的并行开销
- ✅ **路由准确率高**：>85%的分类准确度
- ✅ **置信度评分**：支持0.8-0.95分的评分机制
- ✅ **Qwen模型推理**：使用Qwen3-1.7B进行复杂推理和功效查询判断
- ✅ **实体识别**：基于knowledge_graph_entities_only.csv的46,697个实体
- ✅ **智能降级**：模型加载失败时自动使用规则判断（fallback机制）
- ✅ **显存管理**：支持模型卸载释放显存（适用于评估系统）

### 智能查询分类【v4.0更新】

系统基于Qwen模型、实体识别和关键词规则对查询进行智能分类：

| 路由类型 | 识别特征 | 检索策略 | 置信度 | 示例 |
|---------|---------|---------|--------|------|
| **实体主导型** | 包含≥1个明确实体 | 纯向量检索 (1.0, 0.0) | 0.8-0.95 | "请推荐适合经常口臭的中药" |
| **语义模糊型** | 功效查询或未找到实体 | 纯图谱检索 (0.0, 1.0) | 0.8-0.9 | "生姜的功效有哪些？" |
| **复杂推理型** | 包含"请考虑所有症状"且标点≥5 | 混合检索 (0.5, 0.5) | 0.9 | "我感觉恶寒，但是一直没有出汗..." |

**路由决策逻辑（优先级从高到低）**：
1. **复杂推理判断**：Qwen模型判断是否包含"请考虑所有症状" → COMPLEX_REASONING（置信度0.9）
2. **推荐查询识别**：包含"推荐"、"提供"、"建议"等 → ENTITY_DRIVEN（置信度0.9）
3. **功效查询判断**：Qwen模型判断是否为功效查询 → SEMANTIC_VAGUE（置信度0.9）
4. **实体提取**：使用knowledge_graph_entities_only.csv提取实体 → ENTITY_DRIVEN（置信度0.8-0.95）
5. **默认降级**：未找到实体 → SEMANTIC_VAGUE（置信度0.8）

**Qwen模型判断**：
- `_is_complex_reasoning()`: 判断复杂推理查询
- `_is_effect_query()`: 判断功效查询
- `_is_valid_entity()`: 验证实体有效性
- 包含备用方法（fallback）确保可靠性

**三合一提示词与生成模式【v4.2新增】**：
- **VECTOR模式**：200字限制，严格基于文档内容，强调详细
- **KG模式**：200字限制，允许概念解释，强调简洁准确
- **HYBRID模式**：300字限制，综合向量和图谱结果，平衡全面

### 模型策略【v4.0更新】

**当前模型**：Qwen3-1.7B微调模型（checkpoint-7983）
- **微调完成日期**：2025-10-19
- **微调方法**：LoRA（Low-Rank Adaptation）
- **性能**：中医专业知识准确性显著提升
- **状态**：已部署使用
- **配置位置**：service_config.yaml中的adapter_path已更新

**智能路由模型（IntelligentRouter）**
- **基础模型**：Qwen3-1.7B（用于推理判断）
- **实体库**：knowledge_graph_entities_only.csv（46,697个实体）
- **三大判断模块**：
  1. `_is_complex_reasoning()`: 判断复杂推理查询（包含"请考虑所有症状"）
  2. `_is_effect_query()`: 判断功效查询（药材、方剂的作用、功能等）
  3. `_is_valid_entity()`: 验证实体有效性（药材、病症、食物、穴位等）
- **备用机制**：每个判断模块都有fallback方法，确保可靠性
- **显存管理**：支持unload_model()卸载模型释放显存

**LoRA微调技术**
- **参数效率**：仅微调少量参数，保持基础模型稳定性
- **领域适配**：针对中医领域问答进行专门优化
- **快速部署**：适配器权重独立加载，便于切换和更新

**历史微调版本**

**checkpoint-5584（之前版本）**
- **状态**：已被checkpoint-7983替代
- **位置**：模型层/checkpoint-5584/

**三阶段微调（早期探索）**
- **阶段1-探索期**：checkpoint-5623 - 初步学习中医知识
- **阶段2-收敛期**：checkpoint-5507 - 稳定模型性能
- **阶段3-精化期**：checkpoint-4928 - 精细调优
- **状态**：历史版本，已不再使用

## 数据资源与知识库

### 文档知识库

**数据来源**
- 中医经典著作数字化文本
- 现代中医教材和专业文献
- 中医药数据库和百科全书
- 临床案例和医案记录

**数据处理流程**
1. **数据采集**：多源数据爬取和整合
2. **质量筛选**：从367万文档中精选50万高质量文档
3. **文本清洗**：去重、格式化、错误修正
4. **分词处理**：基于jieba的中医专业分词
5. **索引构建**：BM25索引和向量索引生成

### 知识图谱构建

**实体抽取**
- **方剂实体**：经典方剂、现代方剂
- **药材实体**：中药材、药物成分
- **症状实体**：症状表现、体征描述
- **疾病实体**：中医病名、现代疾病对应
- **治法实体**：治疗方法、调理手段

**关系抽取**
- **组成关系**：方剂-药材组成关系
- **治疗关系**：方剂-疾病治疗关系
- **功效关系**：药材-功效作用关系
- **症状关系**：疾病-症状表现关系
- **配伍关系**：药材间配伍关系

## 系统性能与优化【v4.0更新】

### 性能指标

| 指标类别 | 具体指标 | v3.0数值 | v4.0数值 | v4.1数值 | 改善 |
|---------|----------|---------|---------|---------|------|
| **数据规模** | 图谱节点 | 217,000 | 47,335 | 47,335 | 更新为神农中医知识图谱 |
| | 图谱关系 | 1,600,000 | 402,184 | 402,184 | 更新为神农中医知识图谱 |
| | 向量文档数 | N/A | N/A | 155,902 | Faiss数据库 |
| | 向量维度 | 768 | 768 | 768 | - |
| **响应性能** | 检索时间 | 2-3秒 | 1.5-2.5秒 | 1.5-2.5秒 | ↓ 25% |
| | 向量查询速度 | N/A | N/A | 8.76ms | Faiss优化 |
| | 向量QPS | N/A | N/A | 114 | 新增 |
| | 单一检索时间 | N/A | 1-1.8秒 | 1-1.8秒 | 新增 |
| | 生成时间 | 2-10秒 | 2-8秒 | 2-8秒 | ↓ 20% |
| | 总响应时间 | 4-13秒 | 3.5-10.5秒 | 3.5-10.5秒 | ↓ 25% |
| **智能路由** | 路由准确率 | N/A | >85% | >85% | 新增 |
| | 分类置信度 | N/A | 0.5-0.95 | 0.5-0.95 | 新增 |
| **资源消耗** | GPU显存 | ~4GB | ~4GB | ~4GB | - |
| | 内存需求 | 16GB+ | 16GB+ | 16GB+ | - |
| | 磁盘空间 | 50GB+ | 48GB+ | 46GB+ | ↓ 8% |
| **稳定性** | 系统成功率 | 100% | 100% | 100% | - |
| | Windows死锁 | N/A | 存在 | 已解决 | Faiss迁移 |

### 优化策略【v4.0更新】

**智能路由优化（新增）**
- **快速分类**：基于关键词规则，<10ms完成路由决策
- **单一检索模式**：纯向量或纯图谱检索，避免不必要的并行开销
- **置信度评分**：支持不确定情况的自动降级
- **自适应权重**：根据路由类型动态调整融合权重

**检索优化**
- **智能并行**：仅在混合模式下并行执行向量和图谱检索
- **缓存机制**：热点查询结果缓存，提升响应速度
- **批量处理**：向量计算批量优化
- **索引优化**：Faiss和Neo4j索引优化
- **Windows兼容性**：Faiss完全解决Windows死锁问题

**模型优化**
- **量化推理**：FP16精度推理，减少显存占用
- **基础模型**：暂时使用Qwen3-1.7B基础模型，等待新一轮微调完成
- **动态批处理**：根据负载动态调整批处理大小
- **模型缓存**：模型权重内存缓存，避免重复加载

**系统优化**
- **容器化部署**：Docker容器化，简化部署流程
- **负载均衡**：Nginx反向代理，支持高并发
- **监控告警**：Prometheus + Grafana监控体系
- **日志管理**：结构化日志，便于问题排查

## 技术栈与工具链

### 核心技术栈

| 技术层级 | 技术选型 | 版本 | 作用 |
|---------|----------|------|------|
| **深度学习框架** | PyTorch | 2.0+ | 模型训练和推理 |
| **大语言模型** | Qwen3-1.7B | 3.0 | 基础生成模型 |
| **路由模型** | BERT-base-chinese | - | 智能路由分类 |
| **微调技术** | LoRA | - | 参数高效微调（微调中） |
| **检索框架** | LangChain | 0.1+ | RAG框架和链路管理 |
| **Web框架** | FastAPI | 0.100+ | RESTful API服务 |
| **向量数据库** | Faiss | 1.12.0 | 向量存储和检索 |
| **图数据库** | Neo4j | 5.0+ | 知识图谱存储 |
| **嵌入模型** | BGE-base-zh | - | 文本向量化 |
| **NLP工具** | transformers | 4.30+ | BERT和模型加载 |

### 开发与部署工具

| 工具类别 | 工具名称 | 用途 |
|---------|----------|------|
| **容器化** | Docker | 应用容器化 |
| **服务编排** | Docker Compose | 多服务管理 |
| **反向代理** | Nginx | 负载均衡和静态服务 |
| **监控系统** | Prometheus + Grafana | 性能监控和可视化 |
| **版本控制** | Git | 代码版本管理 |
| **包管理** | pip + conda | Python包管理 |
| **测试框架** | pytest | 单元测试和集成测试 |

## 应用场景与价值

### 主要应用场景

**1. 中医学习辅助**
- 中医院校学生学习参考
- 中医从业者知识查询
- 中医爱好者自学工具

**2. 临床辅助决策**
- 方剂配伍参考
- 症状分析辅助
- 治疗方案建议

**3. 中医知识普及**
- 大众中医科普
- 健康咨询服务
- 养生保健指导

**4. 学术研究支持**
- 中医文献检索
- 知识图谱分析
- 数据挖掘研究

### 社会价值与意义

**传承价值**
- 数字化保存中医传统知识
- 标准化整理中医理论体系
- 智能化传播中医文化

**实用价值**
- 提升中医知识获取效率
- 降低中医学习门槛
- 辅助临床诊疗决策

**创新价值**
- 探索AI+中医结合模式
- 推动中医现代化发展
- 为传统医学数字化提供范例

## 项目特色与优势

### 技术特色【v4.0更新】

1. **五层分布式架构**：从模型层到用户交互层的完整技术栈，职责清晰、高度解耦
2. **智能路由混合检索**：创新的BERT路由分类器 + 向量/图谱双检索架构，自适应选择最优策略
3. **三种检索模式**：纯向量/纯图谱/混合检索，性能提升25%
4. **智能路由决策**：基于查询类型的自动路由，准确率>85%
5. **大规模知识图谱**：47,335个节点、402,184个关系的神农中医知识图谱
6. **端到端优化**：从数据处理到模型部署的全链路优化
7. **完整工程体系**：包含测试、部署、监控、文档的全生命周期管理

### 系统优势【v4.0增强】

1. **更高准确性**：智能路由确保查询匹配最优检索策略，路由准确率>85%
2. **更快响应**：3.5-10.5秒端到端响应，比v3.0提升25%
3. **更智能**：BERT自动分类 + 三种自适应检索模式
4. **强扩展性**：模块化设计，支持功能扩展和技术升级
5. **易部署**：Docker容器化，一键部署和运维
6. **可监控**：完整的监控体系（Prometheus + Grafana），支持性能分析和路由统计
7. **高可用性**：Nginx负载均衡，支持高并发访问

### 创新亮点【v4.0更新】

1. **智能路由创新**：首创BERT智能路由分类器 + 自适应检索模式，路由准确率>85%
2. **架构创新**：五层分布式架构设计，智能路由层无缝集成
3. **领域专业性**：专门针对中医领域优化的检索和生成系统
4. **知识结构化**：将非结构化文本转化为结构化知识图谱（47,335个实体、402,184个关系）
5. **智能化程度高**：BERT路由分类、LLM实体提取、自适应检索策略
6. **性能优化**：比v3.0架构快25%，单一检索模式响应时间减半
7. **工程化水平高**：完整的测试、部署、监控体系，生产级就绪
8. **可持续发展**：预留多模态（MCP）和前端（Dify）集成接口，支持未来扩展

## 未来发展规划

### 短期目标（6个月内）

1. **多模态功能实现**
   - 集成MCP多模态工具层
   - 实现舌诊图像分析功能
   - 添加OCR文字识别能力

2. **用户界面完善**
   - 集成Dify前端界面
   - 优化用户交互体验
   - 添加会话管理功能

3. **性能优化提升**
   - 优化模型推理速度
   - 改进检索算法效率
   - 增强系统稳定性

### 中期目标（1年内）

1. **功能扩展**
   - 添加学术搜索集成
   - 实现多轮对话能力
   - 支持个性化推荐

2. **数据增强**
   - 扩充知识图谱规模
   - 增加多媒体数据支持
   - 提升数据质量

3. **应用推广**
   - 与医疗机构合作试点
   - 开发移动端应用
   - 建立用户反馈机制

### 长期愿景（2-3年）

1. **技术创新**
   - 探索更先进的RAG技术
   - 研究多模态大模型应用
   - 开发专用中医大模型

2. **生态建设**
   - 构建中医AI开发者社区
   - 建立行业标准和规范
   - 推动产学研合作

3. **社会影响**
   - 成为中医数字化标杆项目
   - 推动传统医学现代化
   - 服务全球中医文化传播

## 总结

本项目通过创新的智能路由混合检索增强生成技术，成功构建了一个专业、高效、智能的中医问答系统。v4.0架构在保持高准确性的同时，实现了25%的性能提升，智能路由分类准确率达85%以上。

系统不仅在技术上实现了多项创新（智能路由、自适应检索、性能优化），更在中医知识的数字化传承和智能化应用方面具有重要意义。项目的成功实施证明了AI技术在传统医学领域的巨大潜力，为传统文化的现代化传承提供了新的思路和方法。

通过持续的技术创新和功能完善，本项目将继续在智能医疗、知识图谱、自然语言处理等多个技术领域发挥引领作用，为构建更加智能、便民的医疗健康服务体系贡献力量。

---

## 📝 版本更新日志

### v4.4 (2025-12-XX) - RAG流程优化

#### 重大变更
- ✅ **统一路由决策**：统一为vector_only和hybrid两种路由策略（移除complex_reasoning）
- ✅ **精确召回规则**：
  * 纯向量检索：召回3个文档，生成使用3个文档
  * 混合检索：召回5向量+5图谱（10个），生成用3向量+5图谱（8个），评估用3向量
- ✅ **移除向量关键词增强**：向量检索不再添加"关键词: ..."前缀，直接返回原始文档内容
- ✅ **检索结果标记优化**：所有检索结果正确标记source字段（vector/graph），支持精确过滤
- ✅ **生成文档追踪**：metadata中添加selected_for_generation字段，追踪实际用于生成的文档
- ✅ **查询扩展与重排序集成**：text2vec-base-chinese-paraphrase查询扩展，bge-reranker-base重排序
- ✅ **生成参数统一**：与评估系统（hybrid_ragas_evaluator_v4.py）的参数完全一致
- ✅ **测试体系完善**：test_production_rag_flow.py完整验证RAG流程、文档数量和路由决策

#### 技术细节
- 检索结果格式：`Tuple[List[str], List[str]]` - (generation_contexts, all_retrieval_contexts, evaluation_contexts)
- source字段标记：混合检索时前5个标记为"vector"，后5个标记为"graph"
- 返回结果结构：retrieval_results包含所有10个结果，selected_for_generation包含实际使用的8个结果

---

### v4.2 (2025-10-27) - 关键词增强与三合一优化

#### 重大变更
- ✅ **关键词库路径更新**：从merged_datasets_classified.csv改为knowledge_graph_entities_only.csv
- ✅ **关键词增强功能**：添加停用词过滤，支持单字实体（如"姜"、"枣"）
- ✅ **三合一提示词模板**：新增VECTOR_TEMPLATE、KG_TEMPLATE、HYBRID_TEMPLATE
- ✅ **自适应生成参数**：根据路由决策自动选择vector/kg/hybrid/default四种模式
- ✅ **RAG链路优化**：添加_build_prompt_with_mode()方法，自动应用对应模式
- ✅ **智能路由增强**：使用Qwen-Flash API进行复杂推理、功效查询、实体验证判断
- ✅ **实体识别优化**：基于knowledge_graph_entities_only.csv的46,697个实体库
- ✅ **备用机制**：每个判断模块都包含fallback方法，确保高可靠性

**注意**：v4.4版本中已移除向量检索的关键词增强功能

#### 预期效果
- 答案质量提升：针对不同检索模式优化答案长度和风格
- 一致性提升：使用与评估系统相同的提示词和生成参数
- 忠实度提升：严格的字数控制和内容限制
- 路由准确率提升：Qwen模型推理使复杂查询分类更准确

#### 文件变更
- 更新：`应用协调层/middle/adapters/simple_vector_adapter.py` - 关键词库路径和加载逻辑
- 更新：`应用协调层/middle/services/prompt_templates.py` - 三种提示词模板
- 更新：`应用协调层/middle/services/model_service.py` - 四种生成模式参数
- 更新：`应用协调层/middle/services/rag_chain.py` - 路由决策的新模式应用
- 更新：`应用协调层/middle/utils/intelligent_router.py` - Qwen模型推理增强

---

### v4.1 (2025-10-21) - Faiss向量数据库迁移

#### 重大变更
- ✅ **Faiss向量数据库**：从ChromaDB 1.2.0迁移到Faiss 1.12.0
- ✅ **解决Windows死锁**：完全解决ChromaDB在Windows上的查询死锁问题
- ✅ **性能提升**：查询速度8.76ms，QPS 114，无死锁
- ✅ **数据完整迁移**：155,902条文档成功迁移
- ✅ **微调模型上线**：部署checkpoint-7983微调模型
- ✅ **中医专业知识提升**：相比基础模型，中医专业知识准确性显著提升
- ✅ **知识图谱更新**：切换到神农中医知识图谱（47K节点，40万关系）

#### 技术变更
- 新增：`faiss_manager.py` - Faiss向量库管理器
- 新增：`构建向量数据库_Faiss.py` - Faiss数据库构建脚本
- 更新：`vector_retrieval.py` - 使用FaissManager替代ChromaManager
- 更新：`vector_adapter.py` - 默认路径指向Faiss数据库
- 更新：`requirements.txt` - 添加faiss-cpu==1.12.0

#### 性能提升
- 向量查询速度：8.76ms（Faiss）
- 向量QPS：114
- Windows稳定性：完全解决死锁问题
- 中医专业知识准确性：显著提升
- 模型响应质量：更专业、更准确的中医问答

---

### v4.0 (2025-10-19) - 智能路由混合检索架构

#### 重大变更
- ✅ **移除BM25模块**：从三源检索架构简化为双源检索，专注语义和关系
- ✅ **新增智能路由**：基于BERT-base-chinese的查询分类器
- ✅ **三种检索模式**：
  - 纯向量检索（概念性查询）
  - 纯知识图谱检索（关系性查询）
  - 混合检索（综合性查询）

#### 性能提升
- 检索时间：2-3秒 → 1.5-2.5秒（↓25%）
- 总响应时间：4-13秒 → 3.5-10.5秒（↓25%）
- 单一检索模式响应：N/A → 1-1.8秒（新增）
- 路由准确率：N/A → >85%（新增）

#### 文件变更
- 新增：`应用协调层/langchain/utils/intelligent_router.py`
- 更新：`应用协调层/langchain/utils/query_classifier.py`
- 更新：`应用协调层/langchain/core/retrieval_coordinator.py`
- 更新：`应用协调层/langchain/config/service_config.yaml`
- 更新：`应用协调层/langchain/services/rag_chain.py`
- 废弃：`应用协调层/langchain/adapters/bm25_adapter.py`（保留备份）

---

### v3.0 (2025-10-11) - 双源混合检索架构

#### 核心功能
- 双源混合检索（向量 + 知识图谱）
- Qwen3-1.7B微调模型
- 加权融合算法
- 端到端4-13秒响应

---

**当前版本**: v4.4  
**最后更新**: 2025-12-XX  
**架构状态**: 优化RAG流程（Faiss向量 + Neo4j知识图谱 + Qwen-Flash路由）  
**向量数据库**: Faiss 1.12.0（155,902条文档，无Windows死锁）  
**模型状态**: Qwen3-1.7B微调模型（checkpoint-7983）  
**检索召回规则**:
- 纯向量检索（vector_only）：召回3个，使用3个
- 混合检索（hybrid）：召回5向量+5图谱（10个），生成用3向量+5图谱（8个）
**优化功能**: 移除向量关键词增强 + 精确文档召回规则 + 检索结果source标记 + 生成文档追踪